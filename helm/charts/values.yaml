# Default values for titiler-eopf
replicaCount: 1

# Optional netrc configuration for accessing private repositories
netrc: ""

image:
  repository: ghcr.io/eopf-explorer/titiler-eopf
  tag: latest
  pullPolicy: IfNotPresent
  command: "uvicorn"
  args:
    - "titiler.eopf.main:app"
    - "--host"
    - "0.0.0.0"
    - "--port"
    - "80"
    - "--workers"
    - "1"

nameOverride: ""
fullnameOverride: ""

terminationGracePeriodSeconds: 30

service:
  type: ClusterIP
  port: 80
  annotations: {}

ingress:
  className: ""
  enabled: false
  annotations:
    {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: titiler-eopf.local
      paths: ["/"]
  tls: []
  #  - secretName: titiler-eopf-tls
  #    hosts:
  #      - titiler-eopf.local

extraHostPathMounts: []

imagePullSecrets: []

# Environment variables combining docker-compose.yml and launch.json configurations
env:
  # Application Config
  LOG_LEVEL: "INFO"
  TITILER_EOPF_STORE_URL: "s3://esa-zarr-sentinel-explorer-fra/tests-output/"

  # GDAL Config
  CPL_TMPDIR: /tmp
  GDAL_CACHEMAX: "75%"
  GDAL_DISABLE_READDIR_ON_OPEN: EMPTY_DIR
  GDAL_INGESTED_BYTES_AT_OPEN: "32768"
  GDAL_HTTP_MERGE_CONSECUTIVE_RANGES: "YES"
  GDAL_HTTP_MULTIPLEX: "YES"
  GDAL_HTTP_VERSION: "2"

  # VSI Cache settings
  VSI_CACHE: "TRUE"
  VSI_CACHE_SIZE: "536870912"  # 512MB
  CPL_VSIL_CURL_CACHE_SIZE: "200000000"  # 200MB

  # AWS Configuration
  AWS_ACCESS_KEY_ID: ""  # To be provided via secrets
  AWS_SECRET_ACCESS_KEY: ""  # To be provided via secrets
  AWS_DEFAULT_REGION: "de"
  AWS_ENDPOINT_URL: "https://s3.de.io.cloud.ovh.net/"
  AWS_EC2_METADATA_DISABLED: "true"

# Cache Configuration
cache:
  # Enable tile caching system
  enabled: false
  
  # Cache backend type: "redis", "s3", or "s3-redis"
  backend: "redis"
  
  # TTL settings (seconds)
  ttl:
    default: 3600  # 1 hour
    tiles: 3600
    datasets: 1800  # 30 minutes
  
  # Cache namespace and key generation
  namespace: "titiler-eopf"
  exclude_params:
    - "debug"
    - "timestamp"
    - "auth"
    - "user_id"
    - "session"
    - "token"
  
  # Redis cache configuration
  redis:
    # Use internal Redis deployment (managed by this chart - legacy simple Redis)
    # Note: For production use, enable redis-internal below for enterprise-grade Redis
    internal:
      enabled: false
    
    # Use external Redis instance
    external:
      enabled: false
      host: ""
      port: 6379
      database: 0
      auth:
        enabled: false
        password: ""
        existingSecret: ""
        existingSecretKey: "redis-password"
  
  # S3 cache configuration
  s3:
    enabled: false
    bucket: ""
    region: "us-east-1"
    endpoint_url: ""
    prefix: "cache/"
    
    # S3 Authentication
    auth:
      # Use inline credentials (not recommended for production)
      access_key_id: ""
      secret_access_key: ""
      session_token: ""
      
      # Use existing secret (recommended)
      existingSecret: ""
      accessKeyIdKey: "access-key-id"
      secretAccessKeyKey: "secret-access-key" 
      sessionTokenKey: "session-token"

  # Admin API configuration
  admin:
    enabled: true
    path_prefix: "/admin/cache"
  
  # Monitoring and metrics
  monitoring:
    enabled: false
    prometheus:
      enabled: false
      path: "/metrics"

# Secrets for sensitive environment variables
# You can create a Kubernetes secret with:
# kubectl create secret generic titiler-eopf-secret --from-literal=AWS_ACCESS_KEY_ID=your_access_key --from-literal=AWS_SECRET_ACCESS_KEY=your_secret_key
secrets:
  secretName: titiler-eopf-secret
  keys:
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY

resources:
  limits:
    cpu: 1
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

serviceAccountName: ""

nodeSelector: {}

tolerations: []

affinity: {}

securityContext: {}

podSecurityContext: {}



# Production Redis deployment (managed via Bitnami Redis subchart)
# For production deployments, enable this instead of cache.redis.internal
redis:
  enabled: false  # Default to disabled - set to true for production Redis
  
  # Architecture: standalone (single instance) or replication (master-replica with HA)
  architecture: standalone
  
  # Authentication
  auth:
    enabled: true
    password: ""  # Leave empty to auto-generate secure password
    existingSecret: ""
    existingSecretPasswordKey: "redis-password"
  
  # Master configuration (primary Redis instance)
  master:
    persistence:
      enabled: false  # Match current behavior, enable for production data durability
      size: 1Gi
      storageClass: ""
      accessModes:
        - ReadWriteOnce
    
    resources:
      limits:
        cpu: 1
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi
    
    # Security context for enhanced security
    podSecurityContext:
      enabled: true
      fsGroup: 1001
    
    containerSecurityContext:
      enabled: true
      runAsUser: 1001
      runAsNonRoot: true
      readOnlyRootFilesystem: true
    
    # Enhanced health checks
    livenessProbe:
      enabled: true
      initialDelaySeconds: 20
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 5
    
    readinessProbe:
      enabled: true
      initialDelaySeconds: 20
      periodSeconds: 5
      timeoutSeconds: 1
      failureThreshold: 5
    
    # Service configuration
    service:
      type: ClusterIP
      ports:
        redis: 6379
  
  # Monitoring and observability
  metrics:
    enabled: false  # Enable for Prometheus monitoring
    service:
      type: ClusterIP
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
    
    serviceMonitor:
      enabled: false  # Enable if using Prometheus Operator
      namespace: ""
      additionalLabels: {}
  
  # Common Redis configuration optimized for cache workloads
  commonConfiguration: |
    # Enable AOF persistence for durability
    appendonly yes
    # Optimize memory usage for cache workloads
    maxmemory-policy allkeys-lru
    # Increase timeout for better connection handling
    timeout 0
    # Optimize for cache performance
    save ""
    # Enable keyspace notifications for monitoring
    notify-keyspace-events Ex
  
  # High Availability configuration (only applies when architecture: replication)
  replica:
    persistence:
      enabled: false
      size: 1Gi
      storageClass: ""
    
    resources:
      limits:
        cpu: 1
        memory: 2Gi
      requests:
        cpu: 250m
        memory: 512Mi
    
    # Number of read replicas (HA setup)
    replicaCount: 1
  
  # Sentinel configuration for automatic failover (when architecture: replication)
  sentinel:
    enabled: false  # Enable for automatic failover in HA setup
